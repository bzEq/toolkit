#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import os
import sys
import re
import subprocess
import shlex
import shutil
import tempfile
import logging

HEADER = re.compile(r'NOTE: Assertions have been autogenerated by (.*\.py)')


def Update(monorepo, build, f):
    p = os.path.join(monorepo, 'llvm/test', f)
    with open(p, 'r') as f:
        header = f.readline()
        m = HEADER.search(header)
        if not m:
            return
        cmd = [
            os.path.join(monorepo, 'llvm', m.group(1)),
            p,
        ]
        env = os.environ.copy()
        env['PATH'] = os.path.join(build, 'bin') + os.pathsep + env['PATH']
        subprocess.run(cmd, env=env)


def main():
    filename = sys.argv[1]
    monorepo = sys.argv[2]
    build = sys.argv[3]
    failures = []
    with open(filename, 'r') as f:
        l = f.readline()
        while l:
            l = l.strip()
            try:
                _, t = l.split(':: ')
                failures.append(t)
            except Exception:
                pass
            l = f.readline()
    for f in failures:
        Update(monorepo, build, f)
    return 0


if __name__ == '__main__':
    sys.exit(main())
